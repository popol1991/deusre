<!DOCTYPE html>
<html lang='en' ng-app="filter">
   <head>
   {% include 'head.html' %}
   <script src='/static/js/jquery.tooltipster.min.js'></script>
   <script src='/static/js/jquery-ui.min.js'></script>
   <link rel='stylesheet' href='/static/css/judge.css'>
   <link rel='stylesheet' href='/static/css/jquery-ui.min.css'>
   <link rel='stylesheet' href='/static/css/tooltipster.css'>
   <link rel='stylesheet' href='/static/css/LaTeXML.css'>
   <link rel='stylesheet' href='/static/css/ltx-article.css'>
   <link rel='stylesheet' href='/static/css/ltx-svjour.css'>
   <link rel='stylesheet' href='/static/css/ltx-apj'>
   <link rel='stylesheet' href='/static/css/ltx-ulem'>
   <link rel='stylesheet' href='/static/css/ltx-amsart'>
   <script type="text/javascript">
       var unitInfo = null;
       $.ajax({
            type: 'GET',
            url: '/deusre/judge/unit.json',
            dataType: 'json',
            success: function(data) { unitInfo = data; },
            async: false
       });
       function completed() {
          var i = 0;
          var reldict = {};
          for (;i<{{len}};i++) {
              var rel = $("input[name=rel_"+i+"]:checked").val();
              if (typeof rel == 'undefined') {
                  return null;
              }
              var tableId = $("span#rel_"+i).text();
              reldict[tableId] = rel;
          }
          return reldict;
       };
       function logging(msg) {
            $.ajax({
                    method: "POST",
                    url: "/deusre/judge/log",
                    data: { "message": msg }
            }).done(function(msg) {
            });
       };
        function update_date() {
            var from = $('#datefrom').val();
            if (from.length == 0) from = '0000-00-00';
            var to = $('#dateto').val();
            if (to.length == 0) to = '3000-00-00';

            var facets = eval($('.data-placeholder').html());
            for (var i = 0; i < facets.length; i++) {
                var date = facets[i]['date'];
                var id = "#" + i + "-date";
                if (date > from && date < to) {
                    $(id).addClass('highlight');
                } else {
                    $(id).removeClass('highlight');
                }
            }
            logging("Selecting date range from " + from + " to " + to);
        };
        function normalize(prop, unit, value) {
            if (value == null) {
                return null;
            }
            var conversion = unitInfo[prop]['conversion'][unit];
            var multiplier = conversion['multiplier'];
            var offset = conversion['offset'];
            var normalized = parseFloat(value) * multiplier + offset;
            return normalized;
        };
        function update_facet(id, name) {
            var unit = $('#unit-'+id).find(":selected").val();
            var from = $('#from-'+id).val();
            if (from.length == 0) from = null;
            var to = $('#to-'+id).val();
            if (to.length == 0) to = null;
            if (from != null && to != null && from >= to) {
                alert("Maximum value must be greater than minimum value.");
            }
            alert(unit);
            from = normalize(name, unit, from);
            to = normalize(name, unit, to);
            alert(from);
            alert(to);
            var facets = eval($('.data-placeholder').html());
            for (var i = 0; i < facets.length; i++) {
                var cell_list = facets[i]['cell_list'];
                for (var j = 0; j < cell_list.length; j++) {
                    var cell = cell_list[j];
                    var prop_id = cell['prop'];
                    if (prop_id == id) {
                        var value = cell['value'];
                        alert(value);
                        var selid = "#";
                        for (var k = 0; k < cell['id'].length; k++) {
                            var ch = cell['id'][k];
                            if (ch == '/' || ch == '.') {
                                selid = selid + "\\";
                            }
                            selid = selid + ch;
                        }
                        var gtFrom = from == null || value > from;
                        var ltTo = to == null || value < to;
                        if (gtFrom && ltTo) {
                            alert($(selid).html());
                            $(selid).addClass('highlight');
                        } else {
                            $(selid).removeClass('highlight');
                        }
                    }
                }
            }
        };
       function reminder() {
           var url = window.location.pathname;
           var param = window.location.search;
           var complete = completed();
           if (url.endsWith("submit") && param.length != 0 && complete == null) {
             return "You have unsaved results.";
           } else {
             return null;
           }
       };
       function show_full_caption(id) {
           $('#short-caption-' + id).hide();
           $('#full-caption-' + id).show();
           $('#show-all-' + id).hide();
       }
       $(document).ready(function() {
           $('.short-caption').html(function(idx, oldhtml) {
                var len = oldhtml.length;
                var text = oldhtml.substring(0, 80);
                return text;
           });
           $(function() {
               $("#datefrom").datepicker({changeMonth:true, changeYear: true});
               $("#datefrom").datepicker("option", "dateFormat", "yy-mm-dd");
               $("#dateto").datepicker({changeMonth:true, changeYear: true});
               $("#dateto").datepicker("option", "dateFormat", "yy-mm-dd");
           });
           $('.tooltip').tooltipster({
               content: $('<style>td {padding: 2px 2px 2px 5px;} table {margin-top: 8px;}</style><center><b>Scales for Relevance Judgements</b><center><table style="font-size:14px;"><col width="135px"><tr><td style="vertical-align:middle;">Key Result:</td><td>This table is dedicated to the topic; authoritative and comprehensive, it is worthy of being a top result in a table search engine,</td></tr><tr><td style="vertical-align:middle;">Highly Relevant:</td><td>The content of this table provides substantial information on the topic,</td></tr><tr><td style="vertical-align:middle;">Relevant:</td><td>The content of this table provides some information on the topic, which may be minimal,</td></tr><tr><td style="vertical-align:middle;">Not Relevant:</td><td>The content of this table does not provide useful information on the topic, but may provide useful information on other topics, including other interpretations of the same query,</td></tr><tr><td style="vertical-align:middle;">Broken:</td><td>This table is broken or not readable.</td></tr><table>'),
               theme: 'my-custom-theme'
           });
           window.onbeforeunload = reminder;
           window.onunload = reminder;
       });
   </script>
</head>

<body>
   <!-- Title and search box -->
   <header class="jumbotron">
     <h1 class="neuro-title"><a href="/deusre/judge">Table Search</a></h1>
      <div class="search-box-container">
          <form id='query' data-parsley-validate action="./submit" method="get" autocomplete="off" onsubmit="submitForms()">
            <input type="submit" class="search-button" value="Search">
            <input type='text' name="q" class="search-box" placeholder="Keywords" value="{{ params['q'] }}" autofocus>
            <label>Domain:</label>
            <select name="domain" id="domain">
                    <option value="all">All Domains</option>
                    <option value="Physics">General Physics</option>
                    <option value="Astrophysics">Astrophysics</option>
                    <option value="Condensed Matter">Condensed Matter</option>
                    <option value="High Energy Physics">High Energy Physics</option>
                    <option value="Nonlinear Sciences">Nonlinear Sciences</option>
                    <option value="Nuclear Experiment">Nuclear</option>
                    <option value="Quantum Physics">Quantum Physics</option>
            </select>
          </form>
      </div>
     <div class="info">
       <a class='instruction' href="judge/description">Instruction</a>
     </div>
        <form id='filter-form' data-parley-validate data-ng-controller='filterCtrl'>
            <table class="filter">
            <tr class="filter_item" ng-repeat="filter in filterlist">
                <td><select ng-model="filter.selected" required ng-options="item as item.label for item in filters track by item.id">
                </select></td>
                <td><input data-parsley-type="number" name="{[ filter.selected.name ]}_min" value="{[ filter.selected.min ]}" placeholder="From:"/></td>
                <td><input data-parsley-type="number" name="{[ filter.selected.name]}_max" value="{[ filter.selected.max ]}" placeholder="To:"/></td>
                <td style="border:none"><button class="addFilter" type="button" onclick="removefilter()" ng-click="remove($index)">Remove</button></td>
            </tr>
            <tr>
                <td style="border:none;">Filter:</td>
                <td class="dummy"><input disabled/></td>
                <td class="dummy"><input disabled/></td>
                <td style="border:none;"><button class="addFilter" type="button" onclick="addfilter()" ng-click="addFilter()">Add Filter</button></td>
            </tr>
            </table>
        </form>
     <a class="logout" href="judge/logout">Log out</a>
   </header>

   <!-- Side bar for faceted filtering -->
   <div class="fixed-side-bar" data-ng-controller='facetCtrl'>
       <div class="facet-div">
           <label class="facet-label">Filter by date</label>
           <br>
           <input type="text" id="datefrom" class="facet from" placeholder="Min." onchange="update_date()">
           <input type="text" id="dateto" class="facet to" placeholder="Max." onchange="update_date()">
       </div>
       {% for property in property_list %}
       <div class="facet-div">
           <label class="facet-label">{{ property["name"] }}</label>
           <select id='unit-{{property.id}}' class="facet-unit" onchange="update_facet('{{property.id}}', '{{property.name}}')">
               <option ng-repeat="unit in unitsMap['{{property.name}}']['units']" value='{[unit]}'>{[unit]}</option>
           </select>
           <br>
           <input type="text" id="from-{{property.id}}" class="facet from" placeholder="Min." onchange="update_facet('{{property.id}}','{{property.name}}')">
           <input type="text" id="to-{{property.id}}" class="facet to" placeholder="Max." onchange="update_facet('{{property.id}}', '{{property.name}}')">
       </div>
       {% endfor %}
   </div>

   <!-- Listing of search results -->
   <main class="results-container">
      {% if params != None and len != 0 %}
      <p class="notice">Results are displayed in random order.</p>
      {% endif  %}
      {% if params != None and len == 0 %}
      <p class="notice">No results found.</p>
      {% endif  %}
      <section class='results'>
         {% for hit in hits %}
         <article class='result'>

         <h2>
            <span id="short-caption-{{hit['id']}}">
                <a href="{{ hit.link }}" target="_blank" class="short-caption" onclick='logging("clicked caption {{hit._id}}")'>{{ hit['caption'] }}</a>
            </span>
            {% if hit['caption']|length >= 80 %}
            ...
            <button id="show-all-{{hit['id']}}" onclick="show_full_caption('{{hit['id']}}')">Show all</button>
            <span id="full-caption-{{hit['id']}}" class="full-caption" style="display:none">
                <a href="{{ hit.link }}" target="_blank" onclick='logging("clicked caption {{hit._id}}")'>{{ hit['caption']}}</a>
            </span>
            {% endif %}
         </h2>
            <table>
            <tr><td class="label">From:</td><td>{{ hit['article-title']}}</td></tr>
            <tr><td class="label">Domain:</td><td>{{ ", ".join(hit['domains']) }}</td></tr>
            <tr><td class="label">Submit Date:</td><td id='{{ hit["id"] }}-date'>{{ hit['date'] }}</td></tr>
            </table>
            <br>
            {{ hit.html | safe}}

            <br>
            <!-- Radio button for judgements -->
            <div class="rel-scales">
                <image class="tooltip rel-mark" src="/static/image/question.jpg" />
                <b>Degree of Relevance: </b>
                <input class="rel-radio" type="radio" name="rel_{{hit.id}}" value=4 onclick='logging("clicked radio 4 for table {{hit._id}}")'>Key Result
                <input class="rel-radio" type="radio" name="rel_{{hit.id}}" value=3 onclick='logging("clicked radio 3 for table {{hit._id}}")'>Highly Relevant 
                <input class="rel-radio" type="radio" name="rel_{{hit.id}}" value=2 onclick='logging("clicked radio 2 for table {{hit._id}}")'>Relevant 
                <input class="rel-radio" type="radio" name="rel_{{hit.id}}" value=1 onclick='logging("clicked radio 1 for table {{hit._id}}")'>Not Relevant 
                <input class="rel-radio" type="radio" name="rel_{{hit.id}}" value=0 onclick='logging("clicked radio 0 for table {{hit._id}}")'>Broken 
                <span id="rel_{{hit.id}}" style="display:none">{{hit._id}}</span>
            </div>
         </article>
         {% endfor %}

         {% if params != None and len != 0 %}
         <button class="right save-button" onclick="save('judge/logout')">Save and Logout</button>
         <button class="save-button" onclick="save('judge')">Save and Next</button>
         {% endif  %}
      </section>
   </main>

   <div class="data-placeholder">
       {{ filter_index }}
   </div>

   <script type="text/javascript">
      function submitForms() {
          $('#filter-form :input').not(':submit').clone().hide().appendTo('#query');
      };
      function save(next) {
          var judge = {};
          var reldict = completed();
          if (reldict == null) {
              alert("You have unjudged tables for this query.")
              return;
          }
          judge['query'] = $('form').serializeArray();
          judge['prel'] = reldict;
          // post result to server here
          // redirect to new search page if succeed
          $.post("judge/result", JSON.stringify(judge), function(data) {
              if (data == 'succeed') {
                  alert("Your assesments have been successfully saved!");
                  window.location.replace(next);
              } else {
                  // server side failed to store judge result
                  alert("Server side failure!");
              };
          }).fail(function() {
              alert("Data sending failure!");
          });
      };
   </script>
   </body>
</html>
